<html>
<head>
    <title>Dirigible</title>
    <script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
    <!--<script src="https://apis.google.com/js/api.js" type="text/javascript"></script>-->
    <!--<script type="text/javascript">-->
<!--gapi.load('auth2', init);-->
    <!--</script>-->
    <style>
#media {
	width:100%;
	height:100%;
}
    </style>
</head>
<body>
<video id="media"></video>
<script type='text/javascript'>

var USE_AUTHENTICATED_ACCESS = true;

function MediaLoader(media, video) {
	this.BUFFER_SIZE = 10 * 1024 * 1024 * 1.0;// 10MB
	this.media = media;
	this.isRequesting = false;
	this.video = video;
	this.sourceBuffer;
	this.mediaSource = new MediaSource();
	this.segmentCount = 0;
	this.segmentDuration = 0;
	this.currentSegment = -1;
};

MediaLoader.prototype = {
	initialize: function() {
		console.log('mediaSource: ' + this.mediaSource);
		this.mediaSource.addEventListener('sourceopen', this.createStart(this));
		this.mediaSource.addEventListener('timeupdate', this.checkBuffer);
		this.video.addEventListener('canplay', this.createSetSegmentDuration(this));
		this.video.src = URL.createObjectURL(this.mediaSource);
	},

	createStart: function(mediaLoader) {
		this.start = function() {
			console.log('start, mediaSource: ' + mediaLoader.mediaSource);
			mediaLoader.sourceBuffer = mediaLoader.mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
			mediaLoader.loadContentLength();
		};
		return this.start;
	},

	createSetSegmentDuration: function(mediaLoader) {
		this.setSegmentDuration = function() {
			mediaLoader.segmentDuration = mediaLoader.video.duration / (mediaLoader.segmentCount * 1.0);
			console.log('duration: ' + mediaLoader.video.duration + ', segmentDuration: ' + mediaLoader.segmentDuration);
			mediaLoader.video.removeEventListener('canplay', mediaLoader.setSegmentDuration);
		};
		return this.setSegmentDuration;
	},

	loadContentLength: function() {
		var xhr = new XMLHttpRequest();
		xhr.open('HEAD', this.media.contentId, true);
		xhr.withCredentials = true;
		xhr.setRequestHeader('Authorization', 'Bearer ' + this.media.customData.accessToken);
		xhr.onload = this.createOnContentLengthLoad(xhr, this);
		xhr.onerror = function(e) {
			this.video.src = null;
			window.mediaManager.sendLoadError();
		};
		xhr.send();
	},

	createOnContentLengthLoad: function(xhr, mediaLoader) {
		return function() {
			console.log('xhr.onload, status: ' + xhr.status);

			if (xhr.status != 200) {
				mediaLoader.video.src = null;
				mediaManager.sendLoadError();
				return;
			}

			var contentLength = xhr.getResponseHeader('Content-Length');

			console.log('Content-Length: ' + contentLength);

			mediaLoader.segmentCount = Math.ceil(contentLength / mediaLoader.BUFFER_SIZE);

			console.log('segmentCount: ' + mediaLoader.segmentCount);

			mediaLoader.loadNext();
		};
	},

	loadNext: function() {
		console.log('loadNext: ' + (this.currentSegment + 1));
		this.isRequesting = true;
		var xhr = new XMLHttpRequest();
		xhr.open('GET', this.media.contentId, true);
		xhr.withCredentials = true;
		xhr.setRequestHeader('Authorization', 'Bearer ' + this.media.customData.accessToken);
		var start = (this.currentSegment + 1) * this.BUFFER_SIZE;
		var end = start + this.BUFFER_SIZE;
		xhr.setRequestHeader('Range', 'bytes=' + start + '-' + end);
		xhr.responseType = 'arraybuffer';
		xhr.onload = this.createOnLoad(xhr, this);
		xhr.onprogress = function (event) {
			if (event.lengthComputable) {
				var complete = (event.loaded / (event.total * 1.0) * 100 | 0);// TODO if waiting load, show user % complete
				console.log('xhr.onprogress: ' + complete);
			}
		}
		xhr.onerror = function(e) {
			this.video.src = null;
			window.mediaManager.sendLoadError();
		};
		xhr.send();
	},

	createOnLoad: function(xhr, mediaLoader) {
		return function() {
			console.log('xhr.onload, status: ' + xhr.status);

			mediaLoader.currentSegment++;
			mediaLoader.isRequesting = false;

			if (xhr.status < 200 || xhr.status >= 300) {
				mediaLoader.video.src = null;
				mediaManager.sendLoadError();
				return;
			}

			if (!xhr.response) {
				mediaLoader.video.src = null;
				window.mediaManager.sendLoadError();
				return;
			}

			mediaLoader.sourceBuffer.appendBuffer(xhr.response);
		};
	},

	isLoaded: function() {
		return this.currentSegment >= this.segmentCount;
	},

	nextLoadAt: function() {
		return this.segmentDuration * this.currentSegment * 0.8;
	},

	createCheckBuffer: function(mediaLoader) {
		this.checkBuffer = function() {
			if (mediaLoader.isLoaded()) {
				mediaLoader.sourceBuffer.endOfStream();
				mediaLoader.video.removeEventListener('timeupdate', mediaLoader.checkBuffer);
			} else if (!mediaLoader.isRequesting && mediaLoader.video.currentTime > mediaLoader.nextLoadAt()) {
				mediaLoader.loadNext();
			}
		};
		return this.checkBuffer;
	}
};

window.mediaElement = document.getElementById('media');

if (USE_AUTHENTICATED_ACCESS) {
	// use access token to access media
	window.mediaManager = new cast.receiver.MediaManager(mediaElement);
	mediaManager.onLoad = function (event) {
		console.log('onLoad');

		if (window.mediaPlayer) {
			window.mediaPlayer.unload(); // Ensure unload before loading again
		}

		if (event.data.media && event.data.media.contentId) {
			mediaElement.autoplay = event.data.autoplay;
			window.mediaLoader = new MediaLoader(event.data.media, mediaElement);
			window.mediaLoader.initialize();
		} else {
			mediaManager.sendLoadError();
		}
	};
}

window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
window.castReceiverManager.start();

// stop casting when last sender intentionally disconnects
window.castReceiverManager.onSenderDisconnected = function(event) {
    if (window.castReceiverManager.getSenders().length == 0 &&
        event.reason == cast.receiver.system.DisconnectReason.REQUESTED_BY_SENDER) {
        window.close();
    }
};
</script>
</body>
</html>